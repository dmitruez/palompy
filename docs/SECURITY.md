# Безопасность Palompy

## Завершение TLS и реверс-прокси
- `infrastructure/nginx/palompy.conf` настраивает Nginx на приём HTTPS-трафика (сертификаты Let's Encrypt), принудительный редирект с HTTP на HTTPS, поддержку HTTP/2 и добавление защитных заголовков до проксирования запросов на Node.js backend `127.0.0.1:4000`.
- Маршрут `/api/proxy` доступен только через реверс-прокси, поэтому ключ стороннего API остаётся на сервере, а адрес клиента передаётся через `X-Forwarded-*` заголовки.

## Управление секретами и проксирование API
- `backend/config/env.ts` читает чувствительные переменные из окружения, файлов или JSON-хранилища секретов (`SECRETS_MANAGER_FILE`). Так `THIRD_PARTY_API_KEY` никогда не попадает в браузер и подставляется внутри `ProxyController` перед отправкой запроса.
- Обработчик `/api/proxy` валидирует JWT, проверяет активную подписку и строго применяет RBAC (`integration:invoke` или `admin` через таблицу `user_roles`).

## Middleware уровня веб-безопасности
- Глобальная защита от CSRF выдаёт токены на `GET /api/security/csrf`; все небезопасные методы должны присылать заголовки `X-Session-Id` + `X-CSRF-Token`.
- `backend/security/rateLimiter.ts` реализует лимитирование через Redis с автоматическим fallback на память, чтобы API оставалось доступным при сбое Redis.
- Клиенты, описанные в `docs/`, перед выполнением POST/PUT/PATCH/DELETE должны сначала запросить CSRF-токен.

## Двухфакторная аутентификация (2FA)
- `backend/services/twoFactorService.ts` хранит TOTP-секреты в зашифрованном виде (`AES-256-GCM`), а также recovery-коды и хелперы в таблице `user_security_settings`.
- Роуты `POST /api/security/2fa/setup` и `/enable` позволяют ролям `owner`/`admin` подключать и активировать 2FA.

## Защита данных в состоянии покоя
- В PostgreSQL используются таблицы `user_roles` и `user_security_settings`. Разворачивайте кластер на шифрованных дисках (LUKS или управляемое облако) и ограничивайте доступ к бэкапам (например, S3 с SSE-KMS).
- Stripe (`web/lib/stripe.ts`) принимает платежные данные, поэтому Palompy не хранит PCI-информацию.
- При самостоятельном деплое PostgreSQL включайте `ssl=on`, шифруйте диски и отправляйте бэкапы только на зашифрованные хранилища.
